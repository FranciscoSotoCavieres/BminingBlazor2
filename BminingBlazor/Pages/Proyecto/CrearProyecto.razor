@page "/CrearProyecto"
@using Models
@using BminingBlazor.ViewModels.Project
@using Microsoft.AspNetCore.Http

@inject IProyectoDataService ProyectoDataService
@inject NavigationManager NavigationManager
@inject IUserDataService UserDataService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IHttpContextAccessor HttpContextAccessor

@attribute [Authorize(Roles = "Administracion")]


<h3>CrearProyecto</h3>

<EditForm Model="@newProyecto" OnValidSubmit="@InsertProyecto">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div>
        <label for="inputNombres">  Codigo de Proyecto:  </label>
        <InputText id="Cod_Proyecto" @bind-Value="newProyecto.Cod_Proyecto" />
        <label for="inputNombres">  Nombre de Proyecto:  </label>
        <InputText id="Nombre_Proyecto" @bind-Value="newProyecto.Nombre_Proyecto" />
    </div>
    <div>
        <label for="inputNombres">Cliente:</label>
        <select class="form-control" @bind="newProyecto.Id_Cliente" required>

            @foreach (var cliente in clientes)
            {
                <option value="@cliente.Id_Cliente">@cliente.Nombre_Cliente</option>
            }
        </select>
    </div>
    <div>
        <label for="inputNombres">  Fecha de Inicio:  </label>
        <InputDate id="Fecha_Inicio" @bind-Value="newProyecto.Fecha_Inicio" />
        <label for="inputNombres">  Fecha de Termino:  </label>
        <InputDate id="Fecha_Fin" @bind-Value="newProyecto.Fecha_Fin" />
    </div>
    <div>

        <label for="inputNombres">  Tipo de Proyecto:  </label>
        <select class="form-control" @bind="newProyecto.Cod_TipoProyecto" required>
            @if (tipro != null)
            {
                @foreach (var tipoproyecto in tipro)
                {
                    <option value="@tipoproyecto.Cod_TipoProyecto">@tipoproyecto.Tipo_Proyecto</option>
                }
            }
        </select>

    </div>
    <div>
        <label for="inputNombres">Estado del Proyecto:</label>
        <select class="form-control" @bind="newProyecto.Id_Status" required>

            @foreach (var project in projects)
            {
                <option value="@project.Id_Status">@project.Status</option>
            }
        </select>
    </div>
    <div>
        <label for="inputNombres">  Email Jefe del Proyecto:  </label>
        <select class="form-control" @bind="newProyecto.Id_JefeProyecto" required>
            @foreach (var boss in users)
            {
                <option value="@boss.id">@boss.Email_Bmining</option>
            }
        </select>
    </div>
    <div>
        <MatButton Type="button" OnClick="AddPaymentStatusCallback">
            Agregar Estado de Pago
        </MatButton>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Fecha Limite Pago Emitido</th>
                    <th>Fecha Limite Facturación </th>
                </tr>
            </thead>
            <tbody>
                @foreach (var paymentStatus in _paymentStatusItems)
                {
                    <tr>
                        <td><InputText @bind-Value="@paymentStatus.Name" /></td>
                        <td><InputDate @bind-Value="@paymentStatus.IssueExpirationDate"></InputDate></td>
                        <td><InputDate @bind-Value="@paymentStatus.InvoiceExpirationDate"></InputDate></td>
                        <MatButton Type="button" OnClick="()=>DeletePaymentStatus(paymentStatus)">
                            Eliminar
                        </MatButton>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div>
        <MatButton Type="button" OnClick="AddMembersProjectCallback">
            Agregar Integrantes
        </MatButton>

        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Horas del Proyecto</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var membersProject in _membersProjectItems)
                {
                    <tr>
                        <td>
                            <div class="form-group col-md-6">

                                <select class="form-control" @bind="membersProject.Id_Usuario" required>
                                    @if (users is null)
                                    {
                                    }
                                    else
                                    {
                                        @foreach (var emails in users)
                                        {
                                            <option value="@emails.id">@emails.Email_Bmining</option>
                                        }
                                    }
                                </select>
                            </div>
                        </td>
                        <td><input type="number" step="0.1" @bind="@membersProject.HoursProject" /> </td>
                        <MatButton Type="button" OnClick="()=>DeleteMembersProject(membersProject)">
                            Eliminar
                        </MatButton>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <MatButton type="submit">@Resource.Next</MatButton>

</EditForm>


@code {


    private ProyectoModel newProyecto = new ProyectoModel();
    private List<TipoProyectoModel> tipro;
    private List<UsuarioModel> users;
    private List<PaymentStatusItemViewModel> _paymentStatusItems;
    private List<MembersProjectViewModel> _membersProjectItems;
    private List<ClienteModel> clientes;
    private List<StatusProjectModel> projects;




    private void AddPaymentStatusCallback()
    {
        _paymentStatusItems.Add(new PaymentStatusItemViewModel
        {
            InvoiceExpirationDate = DateTime.UtcNow,
            IssueExpirationDate = DateTime.UtcNow
        });

    }

    private void AddMembersProjectCallback()
    {
        _membersProjectItems.Add(new MembersProjectViewModel());
    }


    private void DeletePaymentStatus(PaymentStatusItemViewModel paymentStatus)
    {
        _paymentStatusItems.Remove(paymentStatus);
    }

    private void DeleteMembersProject(MembersProjectViewModel membersProject)
    {
        _membersProjectItems.Remove(membersProject);
    }

    protected override async Task OnInitializedAsync()
    {
        projects = await ProyectoDataService.ReadStatusProject();
        clientes = await ProyectoDataService.ReadCliente();
        tipro = await ProyectoDataService.ReadTipoProyecto();
        users = await UserDataService.ReadUsers();
        _paymentStatusItems = new List<PaymentStatusItemViewModel>();
        _membersProjectItems = new List<MembersProjectViewModel>();
        string user = HttpContextAccessor.HttpContext.User.Identity.Name;

    }


    protected override void OnInitialized()
    {
        base.OnInitialized();
        newProyecto.Fecha_Inicio = DateTime.Today;
        newProyecto.Fecha_Fin = DateTime.Today;



    }

    private async Task InsertProyecto()
    {
        string user = HttpContextAccessor.HttpContext.User.Identity.Name;
        var id_Creador = await UserDataService.IdUserFromEmail(user);
        var proyecto = new ProyectoModel()
        {
            Cod_Proyecto = newProyecto.Cod_Proyecto,
            Nombre_Proyecto = newProyecto.Nombre_Proyecto,
            Cod_TipoProyecto = newProyecto.Cod_TipoProyecto,
            Fecha_Inicio = newProyecto.Fecha_Inicio,
            Fecha_Fin = newProyecto.Fecha_Fin,
            Id_Creador = id_Creador,
            Id_JefeProyecto = newProyecto.Id_JefeProyecto,
            Id_Cliente = newProyecto.Id_Cliente,
            Id_Status = newProyecto.Id_Status


        };
        var id_proyecto = await ProyectoDataService.CreateProyecto(proyecto);
        foreach (var integrantes in _membersProjectItems)
        {
            var members = new IntegranteModel()
            {
                Id_Proyecto = id_proyecto,
                Id_Usuario = integrantes.Id_Usuario,
                Project_Hours = integrantes.HoursProject
            };
            await ProyectoDataService.AddIntegrante(members);
        }
        foreach (var estados in _paymentStatusItems)
        {
            var status = new EstadoPagoModel()
            {
                Id_Proyecto = id_proyecto,
                Estado_Pago = estados.Name,
                InvoiceExpirationDate = estados.InvoiceExpirationDate,
                IssueExpirationDate = estados.IssueExpirationDate,
                Cod_TipoEstadoPago = 1
            };
            await ProyectoDataService.AddEstadoPago(status);
        }



        NavigationManager.NavigateTo("/Proyectos");

    }

 

  

}
