@page "/ViewProjectReport/{startDate:datetime}/{endDate:datetime}/{codeProject}"
@page "/ViewProjectReport/{startDate:datetime}/{endDate:datetime}/{projectID:int}/{levelSelect:int}"
@page "/ViewProjectReport/{startDate:datetime}/{endDate:datetime}/{codeProject}/{levelSelect:int}"
@using BminingBlazor.ViewModels.Report;
@using System.IO;
@using Microsoft.JSInterop;
@using OfficeOpenXml;
@using OfficeOpenXml.Style;
@using Data;
@using ViewModels.Projects;


@inject IReportService ReportService
@inject IJSRuntime iJSRuntime
@inject NavigationManager NavigationManager


<div class="bmining-app">
    <div class="d-flex flex-row w-100 justify-content-between">
        <div class="d-inline-block">
            <h2>@Resource.Report</h2>
        </div>
    </div>


    @if (_report == null)
    {
        <MatProgressBar Indeterminate="true"></MatProgressBar>
    }
    else
    {@if (root.Son == null || levelselect == 3)
        {
            <div class="table-responsive{-sm|-md|-lg|-xl}">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>@Resource.Name</th>
                            <th>@Resource.Surname</th>
                            <th>@Resource.ProjectCode</th>
                            <th>@Resource.ProjectName</th>
                            <th>@Resource.Hours</th>
                            <th>@Resource.Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var reportMember in _report)
                        {
                            <tr>
                                <td>@reportMember.MyName</td>
                                <td>@reportMember.MyPaternalSurname</td>
                                <td>@reportMember.MyCodProject</td>
                                <td>@reportMember.MyNameProject</td>
                                <td>@reportMember.MyTrackedHours</td>
                                <td>@reportMember.MyDateTracked</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>


            <button class="btn-download float-right" @onclick="ExportExcel"></button>
        }
}
    @if (root.Son != null && levelselect != 3)
    {

        <select class="form-control" id="projectdId" @bind="@idProject" required>
            @{options = root.Son; }
            <option value="@options.Data.MyProjectId">
                @options.Data.MyNameProject
            </option>
            @while (options.Brother != null)
            {
                <option value="@options.Data.MyProjectId">
                    @options.Brother.Data.MyNameProject
                </option>
                options = options.Brother;
            }
        </select>
        <button class="btn-download float-right" @onclick="()=>SelectSon(idProject,1)"></button>
        <button class="btn float-right" @onclick="@proyectoactual">proyecto actual </button>
    }
</div>

@code {

    [Parameter]
    public int userId { get; set; }
    [Parameter]
    public DateTime startDate { get; set; }
    [Parameter]
    public DateTime endDate { get; set; }
    [Parameter]
    public string codeProject { get; set; }
    [Parameter]
    public int levelselect { get; set; }
    [Parameter]
    public int projectId { get; set; }

    public CProject project = new CProject();
    public List<ReportViewModel> _report = new List<ReportViewModel>();
    public ReportViewModel father = new ReportViewModel();
    public List<ReportViewModel> _sons = new List<ReportViewModel>();
    public List<ReportViewModel> _GrandChilds = new List<ReportViewModel>();
    public CNode root = new CNode();
    public CNode n = new CNode();
    public CNode options = new CNode();
    public List<CNode> _listSons = new List<CNode>();
    public int idProject { get; set; }
    public int levelSelect { get; set; }





    protected override async Task OnInitializedAsync()
    {
        if (levelselect == 1)
        {
            _report = await ReportService.GetProjectReportSons(startDate, endDate, projectId);
        }
        else
        {
            _report = await ReportService.GetProjectReportTree(startDate, endDate, codeProject);

            foreach (var report in _report)
            {
                if (report.MyLevel == 0)
                {
                    father = report;
                }
                if (report.MyLevel == 1)
                {
                    _sons.Add(report);
                }
                if (report.MyLevel == 2)
                {
                    _GrandChilds.Add(report);
                }
            }
            root = project.Insertar(father, null);
            foreach (var son in _sons)
            {
                n = project.Insertar(son, root);
                foreach (var grandchild in _GrandChilds)
                {
                    if (grandchild.MyParentId == son.MyProjectId)
                    {
                        project.Insertar(grandchild, n);
                    }
                }
            }
        }

        StateHasChanged();
    }
    public void SelectSon(int projectId, int levelselect)
    {
        NavigationManager.NavigateTo($"/ViewProjectReport/{startDate.ToString("yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture)}/{endDate.ToString("yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture)}/{projectId}/{levelselect}", true);
    }
    public void proyectoactual()
    {
        NavigationManager.NavigateTo($"/ViewProjectReport/{startDate.ToString("yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture)}/{endDate.ToString("yyyy-MM-dd", System.Globalization.CultureInfo.InvariantCulture)}/{codeProject}/{3}", true);
    }

    public async Task ExportExcel()
    {
        GenerateReport generateReport = new GenerateReport()
        { _reports = _report };
        generateReport.GenerateExcel(iJSRuntime);
    }
}

